"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Lint = _interopRequireWildcard(require("../Lint"));

var _Versioning = _interopRequireWildcard(require("../Versioning"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function getName(node) {
  switch (node.type) {
    case 'NewExpression':
      {
        return node.callee.name;
      }

    case 'MemberExpression':
      {
        return node.object.name;
      }

    case 'CallExpression':
      {
        return node.callee.name;
      }

    default:
      throw new Error('not found');
  }
}

var _default = {
  meta: {
    docs: {
      description: 'Ensure cross-browser API compatibility',
      category: 'Compatibility',
      url: 'https://github.com/amilajack/eslint-plugin-compat/blob/master/docs/rules/compat.md',
      recommended: true
    },
    fixable: 'code',
    schema: []
  },

  create(context) {
    // Determine lowest targets from browserslist config, which reads user's
    // package.json config section. Use config from eslintrc for testing purposes
    const browserslistConfig = context.settings.browsers || context.settings.targets || context.options[0];
    const browserslistTargets = (0, _Versioning.Versioning)((0, _Versioning.default)(context.getFilename(), browserslistConfig));
    const errors = [];

    function lint(node) {
      const {
        isValid,
        rule,
        unsupportedTargets
      } = (0, _Lint.default)(node, browserslistTargets, new Set(context.settings.polyfills || []));

      if (!isValid) {
        errors.push({
          node,
          message: [(0, _Lint.generateErrorName)(rule), 'is not supported in', unsupportedTargets.join(', ')].join(' ')
        });
      }
    }

    const identifiers = new Set();
    return {
      CallExpression: lint,
      MemberExpression: lint,
      NewExpression: lint,

      // Keep track of all the defined variables. Do not report errors for nodes that are not defined
      Identifier(node) {
        if (node.parent) {
          const {
            type
          } = node.parent;

          if ( // ex. const { Set } = require('immutable');
          type === 'Property' || // ex. function Set() {}
          type === 'FunctionDeclaration' || // ex. const Set = () => {}
          type === 'VariableDeclarator' || // ex. class Set {}
          type === 'ClassDeclaration' || // ex. import Set from 'set';
          type === 'ImportDefaultSpecifier' || // ex. import {Set} from 'set';
          type === 'ImportSpecifier' || // ex. import {Set} from 'set';
          type === 'ImportDeclaration') {
            identifiers.add(node.name);
          }
        }
      },

      'Program:exit': () => {
        // Get a map of all the variables defined in the root scope (not the global scope)
        // const variablesMap = context.getScope().childScopes.map(e => e.set)[0];
        errors.filter(error => !identifiers.has(getName(error.node))).forEach(node => context.report(node));
      }
    };
  }

};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlcy9jb21wYXQuanMiXSwibmFtZXMiOlsiZ2V0TmFtZSIsIm5vZGUiLCJ0eXBlIiwiY2FsbGVlIiwibmFtZSIsIm9iamVjdCIsIkVycm9yIiwibWV0YSIsImRvY3MiLCJkZXNjcmlwdGlvbiIsImNhdGVnb3J5IiwidXJsIiwicmVjb21tZW5kZWQiLCJmaXhhYmxlIiwic2NoZW1hIiwiY3JlYXRlIiwiY29udGV4dCIsImJyb3dzZXJzbGlzdENvbmZpZyIsInNldHRpbmdzIiwiYnJvd3NlcnMiLCJ0YXJnZXRzIiwib3B0aW9ucyIsImJyb3dzZXJzbGlzdFRhcmdldHMiLCJnZXRGaWxlbmFtZSIsImVycm9ycyIsImxpbnQiLCJpc1ZhbGlkIiwicnVsZSIsInVuc3VwcG9ydGVkVGFyZ2V0cyIsIlNldCIsInBvbHlmaWxscyIsInB1c2giLCJtZXNzYWdlIiwiam9pbiIsImlkZW50aWZpZXJzIiwiQ2FsbEV4cHJlc3Npb24iLCJNZW1iZXJFeHByZXNzaW9uIiwiTmV3RXhwcmVzc2lvbiIsIklkZW50aWZpZXIiLCJwYXJlbnQiLCJhZGQiLCJmaWx0ZXIiLCJlcnJvciIsImhhcyIsImZvckVhY2giLCJyZXBvcnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFDQTs7OztBQWlCQSxTQUFTQSxPQUFULENBQWlCQyxJQUFqQixFQUF1QjtBQUNyQixVQUFRQSxJQUFJLENBQUNDLElBQWI7QUFDRSxTQUFLLGVBQUw7QUFBc0I7QUFDcEIsZUFBT0QsSUFBSSxDQUFDRSxNQUFMLENBQVlDLElBQW5CO0FBQ0Q7O0FBQ0QsU0FBSyxrQkFBTDtBQUF5QjtBQUN2QixlQUFPSCxJQUFJLENBQUNJLE1BQUwsQ0FBWUQsSUFBbkI7QUFDRDs7QUFDRCxTQUFLLGdCQUFMO0FBQXVCO0FBQ3JCLGVBQU9ILElBQUksQ0FBQ0UsTUFBTCxDQUFZQyxJQUFuQjtBQUNEOztBQUNEO0FBQ0UsWUFBTSxJQUFJRSxLQUFKLENBQVUsV0FBVixDQUFOO0FBWEo7QUFhRDs7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aW50LCB7IGdlbmVyYXRlRXJyb3JOYW1lIH0gZnJvbSAnLi4vTGludCc7XG5pbXBvcnQgRGV0ZXJtaW5lVGFyZ2V0c0Zyb21Db25maWcsIHsgVmVyc2lvbmluZyB9IGZyb20gJy4uL1ZlcnNpb25pbmcnO1xuaW1wb3J0IHR5cGUgeyBFU0xpbnROb2RlLCBCcm93c2VyTGlzdENvbmZpZyB9IGZyb20gJy4uL0xpbnRUeXBlcyc7XG5cbnR5cGUgRVNMaW50ID0ge1xuICBbYXN0Tm9kZVR5cGVOYW1lOiBzdHJpbmddOiAobm9kZTogRVNMaW50Tm9kZSkgPT4gdm9pZFxufTtcblxudHlwZSBDb250ZXh0ID0ge1xuICBub2RlOiBFU0xpbnROb2RlLFxuICBzZXR0aW5nczoge1xuICAgIGJyb3dzZXJzOiBBcnJheTxzdHJpbmc+LFxuICAgIHBvbHlmaWxsczogQXJyYXk8c3RyaW5nPlxuICB9LFxuICBnZXRGaWxlbmFtZTogKCkgPT4gc3RyaW5nLFxuICByZXBvcnQ6ICgpID0+IHZvaWRcbn07XG5cbmZ1bmN0aW9uIGdldE5hbWUobm9kZSkge1xuICBzd2l0Y2ggKG5vZGUudHlwZSkge1xuICAgIGNhc2UgJ05ld0V4cHJlc3Npb24nOiB7XG4gICAgICByZXR1cm4gbm9kZS5jYWxsZWUubmFtZTtcbiAgICB9XG4gICAgY2FzZSAnTWVtYmVyRXhwcmVzc2lvbic6IHtcbiAgICAgIHJldHVybiBub2RlLm9iamVjdC5uYW1lO1xuICAgIH1cbiAgICBjYXNlICdDYWxsRXhwcmVzc2lvbic6IHtcbiAgICAgIHJldHVybiBub2RlLmNhbGxlZS5uYW1lO1xuICAgIH1cbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdub3QgZm91bmQnKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIG1ldGE6IHtcbiAgICBkb2NzOiB7XG4gICAgICBkZXNjcmlwdGlvbjogJ0Vuc3VyZSBjcm9zcy1icm93c2VyIEFQSSBjb21wYXRpYmlsaXR5JyxcbiAgICAgIGNhdGVnb3J5OiAnQ29tcGF0aWJpbGl0eScsXG4gICAgICB1cmw6XG4gICAgICAgICdodHRwczovL2dpdGh1Yi5jb20vYW1pbGFqYWNrL2VzbGludC1wbHVnaW4tY29tcGF0L2Jsb2IvbWFzdGVyL2RvY3MvcnVsZXMvY29tcGF0Lm1kJyxcbiAgICAgIHJlY29tbWVuZGVkOiB0cnVlXG4gICAgfSxcbiAgICBmaXhhYmxlOiAnY29kZScsXG4gICAgc2NoZW1hOiBbXVxuICB9LFxuICBjcmVhdGUoY29udGV4dDogQ29udGV4dCk6IEVTTGludCB7XG4gICAgLy8gRGV0ZXJtaW5lIGxvd2VzdCB0YXJnZXRzIGZyb20gYnJvd3NlcnNsaXN0IGNvbmZpZywgd2hpY2ggcmVhZHMgdXNlcidzXG4gICAgLy8gcGFja2FnZS5qc29uIGNvbmZpZyBzZWN0aW9uLiBVc2UgY29uZmlnIGZyb20gZXNsaW50cmMgZm9yIHRlc3RpbmcgcHVycG9zZXNcbiAgICBjb25zdCBicm93c2Vyc2xpc3RDb25maWc6IEJyb3dzZXJMaXN0Q29uZmlnID1cbiAgICAgIGNvbnRleHQuc2V0dGluZ3MuYnJvd3NlcnMgfHxcbiAgICAgIGNvbnRleHQuc2V0dGluZ3MudGFyZ2V0cyB8fFxuICAgICAgY29udGV4dC5vcHRpb25zWzBdO1xuXG4gICAgY29uc3QgYnJvd3NlcnNsaXN0VGFyZ2V0cyA9IFZlcnNpb25pbmcoXG4gICAgICBEZXRlcm1pbmVUYXJnZXRzRnJvbUNvbmZpZyhjb250ZXh0LmdldEZpbGVuYW1lKCksIGJyb3dzZXJzbGlzdENvbmZpZylcbiAgICApO1xuXG4gICAgY29uc3QgZXJyb3JzID0gW107XG5cbiAgICBmdW5jdGlvbiBsaW50KG5vZGU6IEVTTGludE5vZGUpIHtcbiAgICAgIGNvbnN0IHsgaXNWYWxpZCwgcnVsZSwgdW5zdXBwb3J0ZWRUYXJnZXRzIH0gPSBMaW50KFxuICAgICAgICBub2RlLFxuICAgICAgICBicm93c2Vyc2xpc3RUYXJnZXRzLFxuICAgICAgICBuZXcgU2V0KGNvbnRleHQuc2V0dGluZ3MucG9seWZpbGxzIHx8IFtdKVxuICAgICAgKTtcblxuICAgICAgaWYgKCFpc1ZhbGlkKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKHtcbiAgICAgICAgICBub2RlLFxuICAgICAgICAgIG1lc3NhZ2U6IFtcbiAgICAgICAgICAgIGdlbmVyYXRlRXJyb3JOYW1lKHJ1bGUpLFxuICAgICAgICAgICAgJ2lzIG5vdCBzdXBwb3J0ZWQgaW4nLFxuICAgICAgICAgICAgdW5zdXBwb3J0ZWRUYXJnZXRzLmpvaW4oJywgJylcbiAgICAgICAgICBdLmpvaW4oJyAnKVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBpZGVudGlmaWVycyA9IG5ldyBTZXQoKTtcblxuICAgIHJldHVybiB7XG4gICAgICBDYWxsRXhwcmVzc2lvbjogbGludCxcbiAgICAgIE1lbWJlckV4cHJlc3Npb246IGxpbnQsXG4gICAgICBOZXdFeHByZXNzaW9uOiBsaW50LFxuICAgICAgLy8gS2VlcCB0cmFjayBvZiBhbGwgdGhlIGRlZmluZWQgdmFyaWFibGVzLiBEbyBub3QgcmVwb3J0IGVycm9ycyBmb3Igbm9kZXMgdGhhdCBhcmUgbm90IGRlZmluZWRcbiAgICAgIElkZW50aWZpZXIobm9kZSkge1xuICAgICAgICBpZiAobm9kZS5wYXJlbnQpIHtcbiAgICAgICAgICBjb25zdCB7IHR5cGUgfSA9IG5vZGUucGFyZW50O1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIC8vIGV4LiBjb25zdCB7IFNldCB9ID0gcmVxdWlyZSgnaW1tdXRhYmxlJyk7XG4gICAgICAgICAgICB0eXBlID09PSAnUHJvcGVydHknIHx8XG4gICAgICAgICAgICAvLyBleC4gZnVuY3Rpb24gU2V0KCkge31cbiAgICAgICAgICAgIHR5cGUgPT09ICdGdW5jdGlvbkRlY2xhcmF0aW9uJyB8fFxuICAgICAgICAgICAgLy8gZXguIGNvbnN0IFNldCA9ICgpID0+IHt9XG4gICAgICAgICAgICB0eXBlID09PSAnVmFyaWFibGVEZWNsYXJhdG9yJyB8fFxuICAgICAgICAgICAgLy8gZXguIGNsYXNzIFNldCB7fVxuICAgICAgICAgICAgdHlwZSA9PT0gJ0NsYXNzRGVjbGFyYXRpb24nIHx8XG4gICAgICAgICAgICAvLyBleC4gaW1wb3J0IFNldCBmcm9tICdzZXQnO1xuICAgICAgICAgICAgdHlwZSA9PT0gJ0ltcG9ydERlZmF1bHRTcGVjaWZpZXInIHx8XG4gICAgICAgICAgICAvLyBleC4gaW1wb3J0IHtTZXR9IGZyb20gJ3NldCc7XG4gICAgICAgICAgICB0eXBlID09PSAnSW1wb3J0U3BlY2lmaWVyJyB8fFxuICAgICAgICAgICAgLy8gZXguIGltcG9ydCB7U2V0fSBmcm9tICdzZXQnO1xuICAgICAgICAgICAgdHlwZSA9PT0gJ0ltcG9ydERlY2xhcmF0aW9uJ1xuICAgICAgICAgICkge1xuICAgICAgICAgICAgaWRlbnRpZmllcnMuYWRkKG5vZGUubmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgJ1Byb2dyYW06ZXhpdCc6ICgpID0+IHtcbiAgICAgICAgLy8gR2V0IGEgbWFwIG9mIGFsbCB0aGUgdmFyaWFibGVzIGRlZmluZWQgaW4gdGhlIHJvb3Qgc2NvcGUgKG5vdCB0aGUgZ2xvYmFsIHNjb3BlKVxuICAgICAgICAvLyBjb25zdCB2YXJpYWJsZXNNYXAgPSBjb250ZXh0LmdldFNjb3BlKCkuY2hpbGRTY29wZXMubWFwKGUgPT4gZS5zZXQpWzBdO1xuICAgICAgICBlcnJvcnNcbiAgICAgICAgICAuZmlsdGVyKGVycm9yID0+ICFpZGVudGlmaWVycy5oYXMoZ2V0TmFtZShlcnJvci5ub2RlKSkpXG4gICAgICAgICAgLmZvckVhY2gobm9kZSA9PiBjb250ZXh0LnJlcG9ydChub2RlKSk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxufTtcbiJdfQ==